pipeline {
  agent any
  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
    timeout(time: 30, unit: 'MINUTES')
  }
  tools {
    nodejs 'Node_24'
  }
  environment {
    COMPOSE_BASE      = "compose.yml"
    COMPOSE_CI        = "compose.ci.yml"
    COMPOSE_OVERRIDE  = "compose.override.ci.yml"
    // Assure un PATH standard mÃªme en non-login shell
    PATH = "/usr/local/bin:/usr/bin:/bin:${PATH}"
    DOCKER_BUILDKIT = "1"
    // Variables pour la base de donnÃ©es
    DB_PASSWORD = "changeme_ci"
    NODE_ENV = "test"
  }

  stages {
    stage('Checkout') {
      steps { 
        checkout scm
        echo "âœ… Code source rÃ©cupÃ©rÃ©"
      }
    }

    stage('Preflight') {
      steps {
        sh '''#!/bin/bash
          set -euo pipefail
          echo "ðŸ” VÃ©rification de l'environnement CI..."
          
          # Fichiers compose requis
          for f in "$COMPOSE_BASE" "$COMPOSE_CI" "$COMPOSE_OVERRIDE"; do
            [ -f "$f" ] || { echo "::error::$f missing"; exit 1; }
            echo "âœ… $f prÃ©sent"
          done

          # Docker CLI prÃ©sent et exÃ©cutable ?
          if ! command -v docker >/dev/null 2>&1; then
            echo "::error::docker CLI introuvable dans le PATH"
            exit 1
          fi
          echo "âœ… Docker CLI disponible"

          # DÃ©tection Compose v1 vs v2
          if command -v docker-compose >/dev/null 2>&1; then
            COMPOSE_CLI="docker-compose"
          else
            COMPOSE_CLI="docker compose"
          fi
          echo "âœ… Using COMPOSE_CLI='$COMPOSE_CLI'"
          $COMPOSE_CLI version

          # Garde-fou contre bind mount
          if $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" config | grep -qE '\\.:/app'; then
            echo "::error::Bind mount .:/app dÃ©tectÃ© â€” interdit en CI"
            exit 1
          else
            echo "âœ… Aucun bind mount problÃ©matique dÃ©tectÃ©"
          fi
        '''
      }
    }

    stage('Prepare .env') {
      steps {
        sh '''#!/bin/bash
          set -euo pipefail
          echo "ðŸ”§ PrÃ©paration des variables d'environnement pour CI..."
          
          # CrÃ©er .env pour CI
          cat > .env << EOF
# Configuration CI/Test
NODE_ENV=test
DB_PASSWORD=${DB_PASSWORD}
DB_HOST=localhost
DB_PORT=5432
DB_NAME=mydb_test
DB_USER=myapp

# URLs pour tests
FRONTEND_URL=http://localhost:8084
BACKEND_URL=http://localhost:8085

# SÃ©curitÃ©
JWT_SECRET=test_secret_key_change_in_production
BCRYPT_ROUNDS=4

# Logs
LOG_LEVEL=info
EOF
          
          echo "âœ… Fichier .env crÃ©Ã© pour l'environnement CI"
          echo "Contenu (masquÃ© pour sÃ©curitÃ©):"
          sed 's/=.*/=***/' .env
        '''
      }
    }

    stage('Build') {
      parallel {
        stage('Build Backend') {
          steps {
            sh '''#!/bin/bash
              set -euo pipefail
              echo "ðŸ—ï¸ Construction de l'image backend..."
              
              if command -v docker-compose >/dev/null 2>&1; then
                COMPOSE_CLI="docker-compose"
              else
                COMPOSE_CLI="docker compose"
              fi
              
              # Build du backend avec cache layers optimisÃ©
              $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" \
                build backend --pull --no-cache
              
              echo "âœ… Image backend construite avec succÃ¨s"
            '''
          }
        }
        stage('Build Frontend') {
          steps {
            sh '''#!/bin/bash
              set -euo pipefail
              echo "ðŸ—ï¸ Construction de l'image frontend..."
              
              if command -v docker-compose >/dev/null 2>&1; then
                COMPOSE_CLI="docker-compose"
              else
                COMPOSE_CLI="docker compose"
              fi
              
              # Build du frontend
              $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" \
                build frontend --pull --no-cache
              
              echo "âœ… Image frontend construite avec succÃ¨s"
            '''
          }
        }
      }
    }

    stage('Tests') {
      steps {
        sh '''#!/bin/bash
          set -euo pipefail
          echo "ðŸ§ª Lancement des tests unitaires et d'intÃ©gration..."
          
          if command -v docker-compose >/dev/null 2>&1; then
            COMPOSE_CLI="docker-compose"
          else
            COMPOSE_CLI="docker compose"
          fi
          
          # Nettoyer l'environnement prÃ©cÃ©dent
          $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" down --remove-orphans || true
          
          # DÃ©marrer les services de test
          echo "ðŸš€ DÃ©marrage des services pour les tests..."
          $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" up -d db
          
          # Attendre que la DB soit prÃªte
          echo "â³ Attente de la base de donnÃ©es..."
          timeout 60 bash -c 'until $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" exec -T db pg_isready -U myapp -d mydb; do sleep 2; done'
          
          # Lancer les tests backend
          echo "ðŸŽ¯ ExÃ©cution des tests backend..."
          $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" run --rm backend npm test
          
          echo "âœ… Tests passÃ©s avec succÃ¨s"
        '''
      }
    }

    stage('Deploy') {
      steps {
        retry(3) {
          sh '''#!/bin/bash
            set -euo pipefail
            echo "ðŸš€ DÃ©ploiement des services en environnement CI..."
            
            if command -v docker-compose >/dev/null 2>&1; then
              COMPOSE_CLI="docker-compose"
            else
              COMPOSE_CLI="docker compose"
            fi
            
            # Nettoyer et dÃ©ployer
            $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" down --remove-orphans || true
            
            # DÃ©marrer tous les services
            $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" up -d --force-recreate
            
            # Attendre que tous les services soient prÃªts
            echo "â³ VÃ©rification de la santÃ© des services..."
            sleep 10
            
            # VÃ©rifier la santÃ© de la DB
            timeout 60 bash -c 'until $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" exec -T db pg_isready -U myapp -d mydb; do sleep 2; done'
            echo "âœ… Base de donnÃ©es initialisÃ©e"
            
            # VÃ©rifier le backend
            timeout 60 bash -c 'until curl -f http://localhost:8085/health >/dev/null 2>&1; do sleep 3; done'
            echo "âœ… Backend dÃ©marrÃ© et accessible"
            
            # VÃ©rifier le frontend
            timeout 60 bash -c 'until curl -f http://localhost:8084/ >/dev/null 2>&1; do sleep 3; done'
            echo "âœ… Frontend dÃ©marrÃ© et accessible"
            
            echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi!"
          '''
        }
      }
    }

    stage('Smoke Tests') {
      steps {
        sh '''#!/bin/bash
          set -euo pipefail
          echo "ðŸ”¥ Tests de fumÃ©e sur l'application dÃ©ployÃ©e..."
          
          if command -v docker-compose >/dev/null 2>&1; then
            COMPOSE_CLI="docker-compose"
          else
            COMPOSE_CLI="docker compose"
          fi
          
          # Test API Health Check
          echo "Testing Backend Health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8085/health)
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Backend health check passed"
          else
            echo "âŒ Backend health check failed (HTTP $RESPONSE)"
            exit 1
          fi
          
          # Test Frontend
          echo "Testing Frontend..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8084/)
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Frontend accessible"
          else
            echo "âŒ Frontend not accessible (HTTP $RESPONSE)"
            exit 1
          fi
          
          # Test Database Connection
          echo "Testing Database Connection..."
          $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" exec -T db psql -U myapp -d mydb -c "SELECT 1;" >/dev/null
          echo "âœ… Database connection successful"
          
          # Afficher l'Ã©tat des services
          echo "ðŸ“Š Ã‰tat final des services:"
          $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" ps
          
          echo "ðŸŽ¯ Tous les tests de fumÃ©e sont passÃ©s!"
        '''
      }
    }
  }

  post {
    always {
      script {
        sh '''#!/bin/bash
          set -euo pipefail
          if command -v docker-compose >/dev/null 2>&1; then
            COMPOSE_CLI="docker-compose"
          else
            COMPOSE_CLI="docker compose"
          fi
          
          echo "ðŸ§¹ Nettoyage des ressources de test..."
          # Ne pas nettoyer sur la branche main pour garder l'environnement
          if [ "${BRANCH_NAME:-}" != "main" ]; then
            $COMPOSE_CLI -f "$COMPOSE_BASE" -f "$COMPOSE_CI" -f "$COMPOSE_OVERRIDE" down -v || true
            echo "âœ… Environnement de test nettoyÃ©"
          else
            echo "â„¹ï¸ Environnement conservÃ© (branche main)"
          fi
        '''
      }
      cleanWs()
    }
    success { 
      echo 'ðŸŽ‰ âœ… Pipeline Backend complet rÃ©ussi !'
      echo 'ðŸ“Š RÃ©sultats:'
      echo '   - Build: âœ…'
      echo '   - Tests: âœ…'  
      echo '   - DÃ©ploiement: âœ…'
      echo '   - Smoke Tests: âœ…'
    }
    failure { 
      echo 'âŒ Ã‰chec du pipeline backend'
      sh '''#!/bin/bash
        echo "ðŸ” Informations de dÃ©bogage:"
        docker ps -a || true
        if command -v docker-compose >/dev/null 2>&1; then
          docker-compose -f compose.yml -f compose.ci.yml -f compose.override.ci.yml logs --tail=50 || true
        else
          docker compose -f compose.yml -f compose.ci.yml -f compose.override.ci.yml logs --tail=50 || true
        fi
      '''
    }
  }
}
